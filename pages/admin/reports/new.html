<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create New Report - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0f1a;
      --bg-secondary: #111827;
      --bg-card: #1a2234;
      --accent-blue: #3b82f6;
      --accent-teal: #14b8a6;
      --accent-amber: #f59e0b;
      --accent-rose: #f43f5e;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-subtle: rgba(255,255,255,0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 40px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-subtle);
    }

    h1 {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .form-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: none;
    }

    .btn-primary {
      background: var(--accent-teal);
      color: white;
    }

    .btn-primary:hover {
      background: #0d9488;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
    }

    .btn-danger {
      background: transparent;
      color: var(--accent-rose);
      border: 1px solid var(--accent-rose);
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .btn-add {
      background: transparent;
      color: var(--accent-blue);
      border: 1px dashed var(--accent-blue);
    }

    .team-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .team-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-subtle);
    }

    .item-list {
      margin-top: 1rem;
    }

    .item {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }

    .item-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 1rem;
      align-items: start;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      padding-top: 2rem;
      border-top: 1px solid var(--border-subtle);
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 15, 26, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      display: none;
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--border-subtle);
      border-top-color: var(--accent-teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <div class="container">
    <header>
      <h1>Create New Report</h1>
      <p style="color: var(--text-secondary);">Add a new Scrum of Scrums report to the database</p>
    </header>

    <form id="reportForm">
      <!-- Report Details -->
      <div class="form-card">
        <h2 style="margin-bottom: 1.5rem; font-size: 1.3rem;">Report Details</h2>

        <div class="form-group">
          <label for="periodEndDate">Period End Date *</label>
          <input type="date" id="periodEndDate" required>
        </div>

        <div class="form-group">
          <label for="title">Report Title *</label>
          <input type="text" id="title" placeholder="e.g., Scrum of Scrums - Period Ending 01.16.2026" required>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="published">
            <label for="published" style="margin: 0;">Publish immediately</label>
          </div>
        </div>
      </div>

      <!-- Teams -->
      <div class="form-card">
        <h2 style="margin-bottom: 1.5rem; font-size: 1.3rem;">Teams</h2>
        <div id="teamsContainer"></div>
        <button type="button" onclick="addTeam()" class="btn btn-add">+ Add Team</button>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <a href="../index.html" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">Create Report</button>
      </div>
    </form>
  </div>

  <script>
    let teams = [];
    let teamsList = [];
    let leadsList = [];

    // Load teams and leads for dropdowns
    async function loadDropdownData() {
      document.getElementById('loading').classList.add('show');

      try {
        const [teamsRes, leadsRes] = await Promise.all([
          fetch('/api/teams'),
          fetch('/api/team-leads')
        ]);

        if (!teamsRes.ok || !leadsRes.ok) {
          throw new Error('Failed to load dropdown data');
        }

        teamsList = await teamsRes.json();
        leadsList = await leadsRes.json();

        // Add first team by default
        addTeam();

      } catch (error) {
        console.error('Error loading data:', error);
        alert('Error loading form data: ' + error.message);
      } finally {
        document.getElementById('loading').classList.remove('show');
      }
    }

    function addTeam() {
      const teamId = Date.now();
      teams.push({
        id: teamId,
        teamId: '',
        teamLeadId: '',
        accomplishments: [],
        goals: [],
        blockers: [],
        risks: []
      });
      renderTeams();
    }

    function removeTeam(teamId) {
      teams = teams.filter(t => t.id !== teamId);
      renderTeams();
    }

    function addItem(teamId, type) {
      const team = teams.find(t => t.id === teamId);
      if (!team) return;

      team[type].push({
        id: Date.now(),
        sectionName: type === 'accomplishments' || type === 'goals' ? '' : undefined,
        description: '',
        ticketId: '',
        ticketUrl: '',
        workaround: type === 'blockers' ? '' : undefined,
        mitigation: type === 'risks' ? '' : undefined,
        severity: type === 'risks' ? 'medium' : undefined
      });
      renderTeams();
    }

    function removeItem(teamId, type, itemId) {
      const team = teams.find(t => t.id === teamId);
      if (!team) return;
      team[type] = team[type].filter(item => item.id !== itemId);
      renderTeams();
    }

    function renderTeams() {
      const container = document.getElementById('teamsContainer');

      container.innerHTML = teams.map(team => `
        <div class="team-section">
          <div class="team-header">
            <h3>Team ${teams.indexOf(team) + 1}</h3>
            <button type="button" onclick="removeTeam(${team.id})" class="btn btn-danger">Remove Team</button>
          </div>

          <div class="form-group">
            <label>Select Team *</label>
            <select onchange="updateTeam(${team.id}, 'teamId', this.value)" required>
              <option value="">-- Select Team --</option>
              ${teamsList.map(t => `
                <option value="${t.id}" ${team.teamId == t.id ? 'selected' : ''}>${t.name}</option>
              `).join('')}
            </select>
          </div>

          <div class="form-group">
            <label>Team Lead *</label>
            <select onchange="updateTeam(${team.id}, 'teamLeadId', this.value)" required>
              <option value="">-- Select Team Lead --</option>
              ${leadsList.map(l => `
                <option value="${l.id}" ${team.teamLeadId == l.id ? 'selected' : ''}>${l.name}</option>
              `).join('')}
            </select>
          </div>

          <!-- Accomplishments -->
          <div class="item-list">
            <h4 style="margin-bottom: 0.75rem; color: var(--accent-blue);">Accomplishments</h4>
            ${team.accomplishments.map(item => `
              <div class="item">
                <div class="item-row">
                  <div>
                    <input type="text" placeholder="Section (e.g., Ready for UAT)"
                           value="${item.sectionName || ''}"
                           onchange="updateItem(${team.id}, 'accomplishments', ${item.id}, 'sectionName', this.value)">
                  </div>
                  <div>
                    <input type="text" placeholder="Ticket ID"
                           value="${item.ticketId || ''}"
                           onchange="updateItem(${team.id}, 'accomplishments', ${item.id}, 'ticketId', this.value)">
                  </div>
                  <div style="grid-column: 1 / -1; margin-top: 0.5rem;">
                    <textarea placeholder="Description *" required
                              onchange="updateItem(${team.id}, 'accomplishments', ${item.id}, 'description', this.value)">${item.description || ''}</textarea>
                  </div>
                </div>
                <button type="button" onclick="removeItem(${team.id}, 'accomplishments', ${item.id})"
                        class="btn btn-danger" style="margin-top: 0.5rem;">Remove</button>
              </div>
            `).join('')}
            <button type="button" onclick="addItem(${team.id}, 'accomplishments')" class="btn btn-add btn-sm">+ Add Accomplishment</button>
          </div>

          <!-- Goals -->
          <div class="item-list">
            <h4 style="margin-bottom: 0.75rem; color: var(--accent-teal);">Goals</h4>
            ${team.goals.map(item => `
              <div class="item">
                <div class="item-row">
                  <div>
                    <input type="text" placeholder="Section (e.g., In Progress)"
                           value="${item.sectionName || ''}"
                           onchange="updateItem(${team.id}, 'goals', ${item.id}, 'sectionName', this.value)">
                  </div>
                  <div>
                    <input type="text" placeholder="Ticket ID"
                           value="${item.ticketId || ''}"
                           onchange="updateItem(${team.id}, 'goals', ${item.id}, 'ticketId', this.value)">
                  </div>
                  <div style="grid-column: 1 / -1; margin-top: 0.5rem;">
                    <textarea placeholder="Description *" required
                              onchange="updateItem(${team.id}, 'goals', ${item.id}, 'description', this.value)">${item.description || ''}</textarea>
                  </div>
                </div>
                <button type="button" onclick="removeItem(${team.id}, 'goals', ${item.id})"
                        class="btn btn-danger" style="margin-top: 0.5rem;">Remove</button>
              </div>
            `).join('')}
            <button type="button" onclick="addItem(${team.id}, 'goals')" class="btn btn-add btn-sm">+ Add Goal</button>
          </div>

          <!-- Blockers -->
          <div class="item-list">
            <h4 style="margin-bottom: 0.75rem; color: var(--accent-amber);">Blockers</h4>
            ${team.blockers.map(item => `
              <div class="item">
                <textarea placeholder="Description *" required style="margin-bottom: 0.5rem;"
                          onchange="updateItem(${team.id}, 'blockers', ${item.id}, 'description', this.value)">${item.description || ''}</textarea>
                <input type="text" placeholder="Ticket ID (optional)"
                       value="${item.ticketId || ''}"
                       onchange="updateItem(${team.id}, 'blockers', ${item.id}, 'ticketId', this.value)">
                <button type="button" onclick="removeItem(${team.id}, 'blockers', ${item.id})"
                        class="btn btn-danger" style="margin-top: 0.5rem;">Remove</button>
              </div>
            `).join('')}
            <button type="button" onclick="addItem(${team.id}, 'blockers')" class="btn btn-add btn-sm">+ Add Blocker</button>
          </div>

          <!-- Risks -->
          <div class="item-list">
            <h4 style="margin-bottom: 0.75rem; color: var(--accent-rose);">Risks</h4>
            ${team.risks.map(item => `
              <div class="item">
                <textarea placeholder="Description *" required style="margin-bottom: 0.5rem;"
                          onchange="updateItem(${team.id}, 'risks', ${item.id}, 'description', this.value)">${item.description || ''}</textarea>
                <select onchange="updateItem(${team.id}, 'risks', ${item.id}, 'severity', this.value)" style="margin-top: 0.5rem;">
                  <option value="low" ${item.severity === 'low' ? 'selected' : ''}>Low Severity</option>
                  <option value="medium" ${item.severity === 'medium' ? 'selected' : ''}>Medium Severity</option>
                  <option value="high" ${item.severity === 'high' ? 'selected' : ''}>High Severity</option>
                </select>
                <button type="button" onclick="removeItem(${team.id}, 'risks', ${item.id})"
                        class="btn btn-danger" style="margin-top: 0.5rem;">Remove</button>
              </div>
            `).join('')}
            <button type="button" onclick="addItem(${team.id}, 'risks')" class="btn btn-add btn-sm">+ Add Risk</button>
          </div>
        </div>
      `).join('');
    }

    function updateTeam(teamId, field, value) {
      const team = teams.find(t => t.id === teamId);
      if (team) {
        team[field] = value;
      }
    }

    function updateItem(teamId, type, itemId, field, value) {
      const team = teams.find(t => t.id === teamId);
      if (!team) return;

      const item = team[type].find(i => i.id === itemId);
      if (item) {
        item[field] = value;
      }
    }

    document.getElementById('reportForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const periodEndDate = document.getElementById('periodEndDate').value;
      const title = document.getElementById('title').value;
      const published = document.getElementById('published').checked;

      // Prepare teams data
      const teamsData = teams.map(team => ({
        teamId: parseInt(team.teamId),
        teamLeadId: parseInt(team.teamLeadId),
        accomplishments: team.accomplishments.map(item => ({
          sectionName: item.sectionName || 'General',
          description: item.description,
          ticketId: item.ticketId || null,
          ticketUrl: item.ticketId ? `https://cmgfidev.visualstudio.com/_search?text=${item.ticketId}&type=workitem` : null
        })),
        goals: team.goals.map(item => ({
          sectionName: item.sectionName || 'General',
          description: item.description,
          ticketId: item.ticketId || null,
          ticketUrl: item.ticketId ? `https://cmgfidev.visualstudio.com/_search?text=${item.ticketId}&type=workitem` : null
        })),
        blockers: team.blockers.map(item => ({
          description: item.description,
          ticketId: item.ticketId || null,
          ticketUrl: item.ticketId ? `https://cmgfidev.visualstudio.com/_search?text=${item.ticketId}&type=workitem` : null,
          workaround: item.workaround || null
        })),
        risks: team.risks.map(item => ({
          description: item.description,
          mitigation: item.mitigation || null,
          severity: item.severity || 'medium'
        }))
      }));

      document.getElementById('loading').classList.add('show');

      try {
        const response = await fetch('/api/admin/reports', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            periodEndDate,
            title,
            published,
            teams: teamsData
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create report');
        }

        alert('Report created successfully!');
        window.location.href = '../index.html';

      } catch (error) {
        console.error('Error creating report:', error);
        alert('Error: ' + error.message);
      } finally {
        document.getElementById('loading').classList.remove('show');
      }
    });

    // Load dropdown data on page load
    loadDropdownData();
  </script>
</body>
</html>
